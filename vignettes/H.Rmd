---
title: "Introduction To MiamiR"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: true
      smooth_scroll: true
    theme: readable   #e.g. cosmo, cerulean, journal, lumen, paper, sandstone, simplex, spacelab, united, yeti
vignette: >
  %\VignetteIndexEntry{Introduction_To_MiamiR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{css, echo=FALSE}
/* Make page wider but not full edge-to-edge */
body .main-container {
  max-width: 1400px !important; /* adjust to taste: 1200â€“1600 works well */
  width: 100% !important;
}

/* Make code chunks keep spacing and avoid line breaks */
pre {
  background-color: #f8f9fa !important;
  color: #000000 !important;
  white-space: pre !important;
  overflow-x: auto;
}
```

```{r, include = FALSE}

library(knitr)
library(kableExtra)
library(here)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

carousel <- function(plots,
                     save_dir = knitr::fig_path(), 
                     file_prefix = "slide",
                     device = "png",
                     dpi = 144,
                     width_in = 8,
                     height_in = 5) {

  if (!requireNamespace("htmltools", quietly = TRUE)) {
    
    stop("Please install 'htmltools'")
    
  }

  # Coerce to file paths (accepts either file paths or ggplot objects)
  to_path <- function(x, i) {
    if (is.character(x) && length(x) == 1 && file.exists(x)) {
      
      return(x)
      
    }
    if (!inherits(x, "gg")) {
      
      stop("Each element of 'plots' must be a file path or a ggplot object.")
      
    }
    dir.create(save_dir, showWarnings = FALSE, recursive = TRUE)
    f <- file.path(save_dir, sprintf("%s-%02d.%s", file_prefix, i, device))
    ggplot2::ggsave(filename = f, plot = x, dpi = dpi,
                    width = width_in, height = height_in, units = "in", device = device)
    f
  }

  files <- vapply(seq_along(plots), function(i) to_path(plots[[i]], i), character(1))

  # Unique id so multiple carousels can coexist
  id <- paste0("carousel-", paste(sample(c(letters, 0:9), 8, TRUE), collapse = ""))

  slides_html <- paste0(
    vapply(seq_along(files), function(i) {
      
      style <- if (i == 1) "" else ' style="display:none;"'
      
      sprintf('<img class="carousel-slide" src="%s" alt="Plot %d"%s/>',
              files[i], i, style)
      
    }, character(1)),
    collapse = "\n"
  )

  css <- sprintf('
#%1$s { position: relative; max-width: 100%%; text-align: center; }
#%1$s .carousel-slide { max-width: 100%%; height: auto; }
#%1$s .carousel-arrow {
  position: absolute; top: 50%%; transform: translateY(-50%%);
  background: rgba(0,0,0,0.5); color: #fff; border: none;
  padding: 0.5rem 1rem; cursor: pointer; border-radius: 4px; font-size: 1.5rem;
}
#%1$s .carousel-arrow.left { left: 10px; }
#%1$s .carousel-arrow.right { right: 10px; }', id)

  html <- sprintf('
<div id="%1$s">
  %2$s
  <button class="carousel-arrow left" aria-label="Previous">&#10094;</button>
  <button class="carousel-arrow right" aria-label="Next">&#10095;</button>
</div>
<script>
(function(){
  var root = document.getElementById("%1$s");
  var slides = root.querySelectorAll(".carousel-slide");
  var left = root.querySelector(".carousel-arrow.left");
  var right = root.querySelector(".carousel-arrow.right");
  var current = 0;
  function showSlide(idx){
    slides[current].style.display = "none";
    current = (idx + slides.length) %% slides.length;
    slides[current].style.display = "";
  }
  left.addEventListener("click", function(){ showSlide(current - 1); });
  right.addEventListener("click", function(){ showSlide(current + 1); });
})();
</script>', id, slides_html)

  htmltools::HTML(paste0("<style>", css, "</style>", html))
}
```

# Setup and Installation {.tabset} 

- Welcome to the MiamiR software package introductory tutorial, for all yourGWAS and wider genetic data visualisation needs!

- Firstly, the recommended installation for this package is as follows: 

  * Standard Method: remotes::install_github("CRON-Project/MiamiR")

  * Alternative Method: BiocManager::install("CRON-Project/MiamiR")

- If you have any issues please raise issues through GitHub or contact me at: spet5590@ox.ac.uk with subject heading indicating issue.

- Once installed, load in the MiamiR package (lib.loc may need to be specified), This package is complete with extensive documentation and functionality. 

- A web app version will also be available soon (TBC).
```{r setup, message=FALSE}
library(MiamiR)
```

# Single_Plot() {.tabset} 

## Base Example

- Here's how to create a Manhattan plot of the included exemplar 'Intelligence_Sum_Stats' summary statistics data set using the Single_Plot() function included in the package.


# Annotate_Data() {.tabset} 

## Base Example

- Another helper function which is integrated in to the Single_Plot() function under the Auto_Lab argument is Annotate_Data() which uses the coordinates of supplied data and enables annotation with RSIDs for the index SNPs on each chromosome.

- These will be added to the data frame in a new column called Lab. 

- This is particularly useful when creating plots from coordinate-only files.

- This queries an API in a similar way to the Auto_LD functionality in Reigonal_Plot() and as such it is important to bear in mind time constraints and requisite reference genome builds.

- Here is how to use Labelled_Data() in isolation.
```{r, results="hide", warning = FALSE, message = FALSE}
Annotated_Data <- Annotate_Data(Data = Intelligence_Sum_Stats, Genome_Build = "grch37")
```
Let's inspect our annotated data frame.
```{r,  warning = FALSE, message = FALSE}
Annotated_Data[!is.na(Annotated_Data$Lab), c("CHR","POS","A1","A2","Lab")] |>
  head(5) |>
  kable(format = "html", digits = 3, caption = "") |>
  kable_styling(
    full_width = TRUE,                  # <- was FALSE
    position = "center",
    bootstrap_options = c("striped", "hover")  # drop "condensed" to look bigger
  ) |>
  scroll_box(width = "100%")

```

# Tube_Alloys() {.tabset} 

## Base Example

- Last, but not least within the MiamiR package main functions is the Tube_Alloys() function. 

- This function combines Single_Plot(), Regional_Plot() and Forest_Plot() functionality in a blunt fashion to output overall plots, regions of interest and SNP and GWAS modelling information. 

- The user must simply pass GWAS Summary Statistic(s) via any of the aforementioned routes in addition to either combined Phenotype/Covariate files or separate Phenotype and Covariate files if sensitivity analysis is desired. 

- Here is how to run Tube_Alloys(), focusing on chromosome 9 on both 'Intelligence_Sum_Stats' and 'Household_Income_Sum_Stats'.

- In addition we'll supply 'Fake_PHENOS_Binary' and 'Fake_COVARS' datasets included in MiamiR for modelling information. 

- The function will automatically apply defaults and auto-adjustments whilst applying focused arguments to relevant functions, where supplied data allows.

- A special saving, helper function called save_all_plots is also included to facilitate easy output of results.

# METASOFT_File_Gen() {.tabset} 

## Base Example

- A utility function also included in the MiamiR package is the METASOFT_File_Gen() function which takes multiple datasets as inputs and munges them by default to the METASOFT meta-analysis format (wrapper FUTURE/TBC). 

- Other formats may be specified and allele matching is automatically taken care of, similarly to the Forest_Plot() function, with outputs maintaining all SNPs which match the backbone dataset. 

- Here is how to use this simple function using our usual data sets.

<br>
Thank you for reading the tutorial! More functions and functionality coming soon :)
